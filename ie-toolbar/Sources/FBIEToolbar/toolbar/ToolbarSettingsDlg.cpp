/**
* Facebook Internet Explorer Toolbar Software License 
* Copyright (c) 2009 Facebook, Inc. 
*
* Permission is hereby granted, free of charge, to any person or organization
* obtaining a copy of the software and accompanying documentation covered by
* this license (which, together with any graphical images included with such
* software, are collectively referred to below as the "Software") to (a) use,
* reproduce, display, distribute, execute, and transmit the Software, (b)
* prepare derivative works of the Software (excluding any graphical images
* included with the Software, which may not be modified or altered), and (c)
* permit third-parties to whom the Software is furnished to do so, all
* subject to the following:
*
* The copyright notices in the Software and this entire statement, including
* the above license grant, this restriction and the following disclaimer,
* must be included in all copies of the Software, in whole or in part, and
* all derivative works of the Software, unless such copies or derivative
* works are solely in the form of machine-executable object code generated by
* a source language processor.  
*
* Facebook, Inc. retains ownership of the Software and all associated
* intellectual property rights.  All rights not expressly granted in this
* license are reserved by Facebook, Inc.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
* SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
* FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
* ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
* DEALINGS IN THE SOFTWARE.
*/ 

#include "StdAfx.h"

#include "ToolbarSettingsDlg.h"

#include "UpdateUrlDlg.h"

#include "../../data/ToolbarSettings.h"

#include "../../common/CommonConstants.h"
#include "../../common/ResourceMessages.h"

#include "../../util/BitsUtils.h"
#include "../../util/GdiUtils.h"
#include "../../util/ShellUtils.h"
#include "../../util/WndUtils.h"

namespace facebook {

// ---------------------------------------------------------------------
// class ToolbarSettingsDlg
// ---------------------------------------------------------------------


IMPLEMENT_DYNAMIC(ToolbarSettingsDlg, CDialog)


BEGIN_MESSAGE_MAP(ToolbarSettingsDlg, CDialog)
   ON_BN_CLICKED(IDOK, &ToolbarSettingsDlg::OnBtnOk)
END_MESSAGE_MAP()


ToolbarSettingsDlg::ToolbarSettingsDlg(CWnd* pParent /*=NULL*/)
  : CDialog(ToolbarSettingsDlg::IDD, pParent)
   , newFriendRequest_(FALSE)
   , newMessage_(FALSE)
   , newPoke_(FALSE)
   , newFriend_(FALSE)
   , newEventInvite_(FALSE)
   , newShare_(FALSE)
   , smoneWroteWall_(FALSE)
   , afuProfile_(FALSE)
   , afuStatus_(FALSE)
   , afuAlbums_(FALSE)
   , afuWall_(FALSE)
   , afwNote_(FALSE)
   , popupNotification_(FALSE)
   , groupInv_(FALSE)
   , checkUpdates_(FALSE) {
     ResourceMessages::subscribeObserver(this);
}

ToolbarSettingsDlg::~ToolbarSettingsDlg() {
  ResourceMessages::unsubscribeObserver(this);
}

void ToolbarSettingsDlg::DoDataExchange(CDataExchange* pDX) {
   CDialog::DoDataExchange(pDX);
   DDX_Check(pDX, IDC_CHK_NFRIEND_REQ, newFriendRequest_);
   DDX_Check(pDX, IDC_CHK_NMESSAGE, newMessage_);
   DDX_Check(pDX, IDC_CHK_NPOKE, newPoke_);
   DDX_Check(pDX, IDC_CHK_NFRIEND, newFriend_);
   DDX_Check(pDX, IDC_CHK_NEVENT_INV, newEventInvite_);
   DDX_Check(pDX, IDC_CHK_NSHARE, newShare_);
   DDX_Check(pDX, IDC_CHK_SWROTE_WALL, smoneWroteWall_);
   DDX_Check(pDX, IDC_CHK_AFU_PROFILE, afuProfile_);
   DDX_Check(pDX, IDC_CHK_AFU_STATUS, afuStatus_);
   DDX_Check(pDX, IDC_CHK_AFU_ALBUMS, afuAlbums_);
   DDX_Check(pDX, IDC_CHK_AFU_WALL, afuWall_);
   DDX_Check(pDX, IDC_CHK_AF_NOTE, afwNote_);
   DDX_Check(pDX, IDC_CHK_POPUP_NOTIF, popupNotification_);
   DDX_Check(pDX, IDC_CHK_GROUP_INV, groupInv_);
   DDX_Check(pDX, IDC_CHK_UPDATES, checkUpdates_);
}


BOOL ToolbarSettingsDlg::OnInitDialog() {
   loadData();
   initControlList();
   updateView(0);

   return CDialog::OnInitDialog();
}

void ToolbarSettingsDlg::updateView(int changeId) {
  UNREFERENCED_PARAMETER(changeId);

  SetWindowText(ResourceMessages::getMessage(kSettingsConfigureTheFacebookToolbar).c_str());

  SetDlgItemText(IDC_CHK_POPUP_NOTIF, ResourceMessages::getMessage(kSettingsEnablePopUpNotification).c_str());
  SetDlgItemText(IDC_STATIC_GR1, ResourceMessages::getMessage(kSettingsNotificationAboutMe).c_str());
  SetDlgItemText(IDC_CHK_NFRIEND_REQ, ResourceMessages::getMessage(kSettingsNewFriendRequest).c_str());
  SetDlgItemText(IDC_CHK_NMESSAGE, ResourceMessages::getMessage(kSettingsNewMessage).c_str());
  SetDlgItemText(IDC_CHK_NPOKE, ResourceMessages::getMessage(kSettingsNewPoke).c_str());
  SetDlgItemText(IDC_CHK_NFRIEND, ResourceMessages::getMessage(kSettingsNewFriend).c_str());
  SetDlgItemText(IDC_CHK_NEVENT_INV, ResourceMessages::getMessage(kSettingsNewEventInvite).c_str());
  SetDlgItemText(IDC_CHK_GROUP_INV, ResourceMessages::getMessage(kSettingsNewGroupInvite).c_str());
  SetDlgItemText(IDC_CHK_NSHARE, ResourceMessages::getMessage(kSettingsNewShare).c_str());
  SetDlgItemText(IDC_CHK_SWROTE_WALL, ResourceMessages::getMessage(kSettingsSomeoneWroteOnYourWall).c_str());
  SetDlgItemText(IDC_STATIC_GR2, ResourceMessages::getMessage(kSettingsNotificationAboutMyFriends).c_str());
  SetDlgItemText(IDC_CHK_AFU_PROFILE, ResourceMessages::getMessage(kSettingsAFriendUpdatedHisHerProfile).c_str());
  SetDlgItemText(IDC_CHK_AFU_STATUS, ResourceMessages::getMessage(kSettingsAFriendUpdatedHisHerStatus).c_str());
  SetDlgItemText(IDC_CHK_AFU_ALBUMS, ResourceMessages::getMessage(kSettingsAFriendUpdatedHisHerAlbums).c_str());
  SetDlgItemText(IDC_CHK_AFU_WALL, ResourceMessages::getMessage(kSettingsAFriendUpdatedHisHerWall).c_str());
  SetDlgItemText(IDC_CHK_AF_NOTE, ResourceMessages::getMessage(kSettingsAFriendWroteANote).c_str());
  SetDlgItemText(IDC_CHK_UPDATES, ResourceMessages::getMessage(kSettingsCheckForUpdates).c_str());
  SetDlgItemText(IDOK, ResourceMessages::getMessage(kButtonOk).c_str());
  SetDlgItemText(IDCANCEL, ResourceMessages::getMessage(kButtonCancel).c_str());

  loadUpdatesStatus();

  // Set dimensions snd position, depend on the text
  CRect rect;
  GetWindowRect(&rect);
  adjustWindowSize();
  resizeControls(rect);
  adjustButtonsPos();

  // Invert current dialog if current toolbar language is right aligned
  if (ResourceMessages::isTextRightAligned()) {
    invertDialog();
  }
}

void ToolbarSettingsDlg::invertDialog() {
  // Margin between window border and test static box
  const int updateTextMargin = 34;
  alignDialogButtons(this);

  CRect rectUpdateText, rectWindow;
  GetDlgItem(IDC_UPDATE_STATUS)->GetWindowRect(&rectUpdateText);
  GetWindowRect(&rectWindow);
  ScreenToClient(&rectUpdateText);
  ScreenToClient(&rectWindow);
  // Move Update text notification to the correct 
  // position for right aligned dialog
  GetDlgItem(IDC_UPDATE_STATUS)->SetWindowPos(NULL, 
    rectWindow.Width() - rectUpdateText.Width() - updateTextMargin,
    rectUpdateText.top, 0, 0, SWP_NOZORDER | SWP_NOSIZE);

  // Set controls style to right to left
  for (std::list<CWnd*>::iterator it = controls_.begin(); it != controls_.end(); it++) {
    addExStyle((*it)->GetSafeHwnd(), WS_EX_LAYOUTRTL);
  }
  // Set window style to right to left
  addExStyle(GetSafeHwnd(), WS_EX_LAYOUTRTL, true);
}

void ToolbarSettingsDlg::adjustWindowSize() {
  SIZE textSize;
  HFONT windowFont = (HFONT)::SendMessage(GetSafeHwnd(), WM_GETFONT, 0, 0);
  HDC context = ::GetDC(GetSafeHwnd());
  SelectObject(context, windowFont);

  int maxLength = 0; 
  CString controlText;
  // Determine max text length in pixels
  for (std::list<CWnd*>::iterator it = controls_.begin(); it != controls_.end(); it++) {
    (*it)->GetWindowText(controlText);
    GetTextExtentPoint32(context, String(controlText.GetString()).c_str(), 
      String(controlText.GetString()).length(), &textSize);
    if (textSize.cx > maxLength) {
      maxLength = textSize.cx;
    }
  }

  CRect rect;
  GetWindowRect(&rect);
  const int additionWidth = 122; // Additional width for dialog
  const int minWidth = 298; // Minimum window width
  if (maxLength + additionWidth > minWidth) {
    SetWindowPos(0, 0, 0, maxLength + additionWidth, rect.Height(),
      SWP_NOZORDER | SWP_NOMOVE);
  }
}

void ToolbarSettingsDlg::resizeControls(CRect oldWindowSize) {
  CRect controlRect;
  CRect windowRect;
  GetWindowRect(&windowRect);
  int additionWidth = windowRect.Width() - oldWindowSize.Width() - 2;
  for (std::list<CWnd*>::iterator it = controls_.begin(); it != controls_.end(); it++) {
    (*it)->GetWindowRect(&controlRect);
    ScreenToClient(&controlRect);
    (*it)->MoveWindow(controlRect.left, controlRect.top, 
      controlRect.Width() + additionWidth, controlRect.Height(), TRUE);
  }
}

void ToolbarSettingsDlg::adjustButtonsPos() {
  const int textMargin = 20; // Button text margin
  const int btnPadding = 15; // Button padding
  
  SIZE textSize;
  HFONT windowFont = (HFONT)::SendMessage(GetSafeHwnd(), WM_GETFONT, 0, 0);
  HDC context = ::GetDC(GetSafeHwnd());
  SelectObject(context, windowFont);

  CRect windowRect;
  GetWindowRect(&windowRect);

  // Set Cancel Button
  String message = ResourceMessages::getMessage(kButtonCancel);
  GetTextExtentPoint32(context, message.c_str(), message.length(), &textSize);

  int buttonWidth = textSize.cx + 2 * textMargin;
  int cancelButtonX = windowRect.Width() - btnPadding - buttonWidth;
  moveButton(IDCANCEL, buttonWidth, cancelButtonX);

  // Set Ok Button
  message = ResourceMessages::getMessage(kButtonOk);
  GetTextExtentPoint32(context, message.c_str(), message.length(), &textSize);

  buttonWidth = textSize.cx + 2 * textMargin;
  int okButtonX = cancelButtonX - btnPadding / 2 - buttonWidth;
  moveButton(IDOK, buttonWidth, okButtonX);
}

void ToolbarSettingsDlg::moveButton(int id, int width, int offsetX) {
  CRect controlRect;
  CWnd* btn = GetDlgItem(id);
  btn->GetWindowRect(&controlRect);
  ScreenToClient(&controlRect);
  btn->MoveWindow(offsetX, controlRect.top, 
    width, controlRect.Height(), TRUE);
}

void ToolbarSettingsDlg::loadData() {
   popupNotification_ = ToolbarSettings::getInstance().readValue(TO_NEWPOPUPNOTIFICATION, true);
   newFriendRequest_  = ToolbarSettings::getInstance().readValue(TO_NEWFRIENDREQUEST, true);
   newMessage_ = ToolbarSettings::getInstance().readValue(TO_NEWMESSAGE, true);
   newPoke_ = ToolbarSettings::getInstance().readValue(TO_NEWPOKE, false);
   newFriend_ = ToolbarSettings::getInstance().readValue(TO_NEWFRIEND, false);
   newEventInvite_ = ToolbarSettings::getInstance().readValue(TO_NEWEVENTINVITE, false);
   newShare_ = ToolbarSettings::getInstance().readValue(TO_NEWSHARE, false);
   smoneWroteWall_ = ToolbarSettings::getInstance().readValue(TO_NEWSMONEWROTEWALL, true);
   afuProfile_ = ToolbarSettings::getInstance().readValue(TO_FRIENDUPDATEDUPROFILE, false);
   afuStatus_ = ToolbarSettings::getInstance().readValue(TO_FRIENDUPDATEDSTATUS, false);
   afuAlbums_ = ToolbarSettings::getInstance().readValue(TO_FRIENDUPDATEDALBUMS, false);
   afuWall_ = ToolbarSettings::getInstance().readValue(TO_FRIENDUPDATEDWALL, false);
   afwNote_ = ToolbarSettings::getInstance().readValue(TO_FRIENDWROTENOTE, false);
   groupInv_ = ToolbarSettings::getInstance().readValue(TO_NEWGROUPINVITE, false);
   checkUpdates_ = ToolbarSettings::getInstance().readValue(TO_CHECKUPDATES, true);
   if (!checkUpdates_) {
     ::ShowWindow(::GetDlgItem(GetSafeHwnd(), IDC_UPDATE_STATUS), SW_HIDE);
   }
   UpdateData(FALSE);
}

void ToolbarSettingsDlg::saveData() {
   UpdateData(TRUE);
   ToolbarSettings::getInstance().writeValue(TO_NEWPOPUPNOTIFICATION, popupNotification_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_NEWFRIENDREQUEST, newFriendRequest_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_NEWMESSAGE, newMessage_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_NEWPOKE, newPoke_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_NEWFRIEND, newFriend_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_NEWEVENTINVITE, newEventInvite_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_NEWSHARE, newShare_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_NEWSMONEWROTEWALL, smoneWroteWall_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_FRIENDUPDATEDUPROFILE, afuProfile_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_FRIENDUPDATEDSTATUS, afuStatus_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_FRIENDUPDATEDALBUMS, afuAlbums_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_FRIENDUPDATEDWALL, afuWall_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_FRIENDWROTENOTE, afwNote_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_NEWGROUPINVITE, groupInv_ == TRUE);
   ToolbarSettings::getInstance().writeValue(TO_CHECKUPDATES, checkUpdates_ == TRUE);
}

void ToolbarSettingsDlg::loadUpdatesStatus() {
  BitsUtils bits;
  BitsUtils::BitsDownloadStatus status = 
    bits.checkDownloadStatus(kFacebookUpdateJobName);
  switch (status) {
    case BitsUtils::DOWNLOAD_COMPLETED:
      SetDlgItemText(IDC_UPDATE_STATUS, ResourceMessages::getMessage(kUpdateAvailable).c_str());
      break;
   case BitsUtils::DOWNLOAD_IN_PROGRESS:
      SetDlgItemText(IDC_UPDATE_STATUS, ResourceMessages::getMessage(kUpdateInProgress).c_str());
      break;
   default:
      SetDlgItemText(IDC_UPDATE_STATUS, ResourceMessages::getMessage(kNoUpdates).c_str());
      break;
  }
}

// ToolbarSettingsDlg message handlers

void ToolbarSettingsDlg::OnBtnOk() {
   saveData();
   OnOK();
}

BOOL ToolbarSettingsDlg::PreTranslateMessage(MSG* pMsg) {
  //catch Ctrl + Shift + R for special debug settings
  if (pMsg->message == WM_KEYDOWN) {
    if (pMsg->wParam == 'R') { 
      const bool shiftPressed = GetKeyState(VK_SHIFT) < 0;
      const bool ctrlPressed = GetAsyncKeyState(VK_CONTROL) < 0;
      if (shiftPressed && ctrlPressed) {
        UpdateUrlDlg updateUrlDialog;
        updateUrlDialog.DoModal();
      }
    }
  }
  return CDialog::PreTranslateMessage(pMsg);
}

void ToolbarSettingsDlg::initControlList() {
  controls_.push_back(GetDlgItem(IDC_CHK_POPUP_NOTIF));
  controls_.push_back(GetDlgItem(IDC_STATIC_GR1));
  controls_.push_back(GetDlgItem(IDC_CHK_NFRIEND_REQ));
  controls_.push_back(GetDlgItem(IDC_CHK_NMESSAGE));
  controls_.push_back(GetDlgItem(IDC_CHK_NPOKE));
  controls_.push_back(GetDlgItem(IDC_CHK_NFRIEND));
  controls_.push_back(GetDlgItem(IDC_CHK_NEVENT_INV));
  controls_.push_back(GetDlgItem(IDC_CHK_GROUP_INV));
  controls_.push_back(GetDlgItem(IDC_CHK_NSHARE));
  controls_.push_back(GetDlgItem(IDC_CHK_SWROTE_WALL));
  controls_.push_back(GetDlgItem(IDC_STATIC_GR2));
  controls_.push_back(GetDlgItem(IDC_CHK_AFU_PROFILE));
  controls_.push_back(GetDlgItem(IDC_CHK_AFU_STATUS));
  controls_.push_back(GetDlgItem(IDC_CHK_AFU_ALBUMS));
  controls_.push_back(GetDlgItem(IDC_CHK_AFU_WALL));
  controls_.push_back(GetDlgItem(IDC_CHK_AF_NOTE));
  controls_.push_back(GetDlgItem(IDC_CHK_UPDATES));
  controls_.push_back(GetDlgItem(IDC_UPDATE_STATUS));
}

} //!namespace facebook